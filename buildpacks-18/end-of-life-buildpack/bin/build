#!/usr/bin/env bash

set -euo pipefail

ENV_DIR="${2}/env"
ALLOW_BUILD="$(cat "${ENV_DIR}/ALLOW_INSECURE_HEROKU_18_BUILDER" 2> /dev/null || true)"

function echo_stderr() {
  local ansi_red="\033[1;31m"
  local ansi_reset="\033[0m"
  echo -e "\n${ansi_red}${1}${ansi_reset}\n" >&2
}

read -r -d '' EOL_MESSAGE <<'EOF' || true
This builder image (heroku/buildpacks:18) is based upon the Heroku-18
stack, which has been end-of-life since April 30th, 2023:
https://devcenter.heroku.com/changelog-items/2583

The underlying Ubuntu 18.04 OS is no longer receiving security updates,
and so apps still using it could contain security vulnerabilities.

Please switch to one of our newer 'heroku/builder:*' builder images:
https://github.com/heroku/builder#heroku-builder-images

If you are using the Pack CLI, you will need to adjust the '--builder' CLI
argument, or else change the default builder configuration:
https://buildpacks.io/docs/tools/pack/cli/pack_config_default-builder/
EOF

if [[ "${ALLOW_BUILD}" == "1" ]]; then
  echo_stderr "Warning: ${EOL_MESSAGE}"
  exit 0
else
  echo_stderr "Error: ${EOL_MESSAGE}"
  echo_stderr "To ignore this error, set the env var ALLOW_INSECURE_HEROKU_18_BUILDER to 1."
  exit 1
fi
