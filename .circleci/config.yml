version: 2.0
jobs:
  clone:
    docker:
      image: circleci/golang:1.12.5
    steps:
      - checkout
      - save-cache:
          key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - ~/project
  docker-prep:
    docker:
      image: circleci/golang:1.12.5
    steps:
      - setup_remote_docker:
         docker_layer_caching: true
      - run: docker pull heroku/heroku:18-build
      - run: docker pull heroku/heroku:18
  install-buildpacks:
    docker:
      image: circleci/golang:1.12.5
    steps:
      - restore_cache:
          key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
      - run: pwd; ls
      - run: ./buildpacks/install.sh
      - save-cache:
          key: v1-buildpacks-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - ~/project/buildpacks
  docker-build-run-image:
    docker:
      image: circleci/golang:1.12.5
    steps:
      - restore_cache:
          key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: v1-buildpacks-{{ .Environment.CIRCLE_SHA1 }}
      - setup_remote_docker:
         docker_layer_caching: true
      - run: docker build -f Dockerfile.run -t heroku/pack:18 .
  docker-build-build-image:
    docker:
      image: circleci/golang:1.12.5
    steps:
      - restore_cache:
          key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: v1-buildpacks-{{ .Environment.CIRCLE_SHA1 }}
      - setup_remote_docker:
         docker_layer_caching: true
      - run: docker build -f Dockerfile.build -t heroku/pack:18-build .
  create-builder-image:
    docker:
      image: circleci/golang:1.12.5
    steps:
      - restore_cache:
          key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: v1-buildpacks-{{ .Environment.CIRCLE_SHA1 }}
      - setup_remote_docker:
         docker_layer_caching: true
      - run: go get github.com/buildpack/pack/cmd/pack
      - run: mkdir -p ~/.docker
      - run: echo {} > ~/.docker/config.json
      - run: pack create-builder heroku/buildpacks:18-test --builder-config builder.toml --no-pull
  test-go:
    docker:
      image: circleci/golang:1.12.5
    steps:
      - run: git clone git@github.com:heroku/go-getting-started
      - run: pack build heroku/go-getting-started:test --path go-getting-started --builder heroku/buildpacks:18-test
workflows:
  version: 2
  test-languages:
    jobs:
      - clone
      - docker-prep
      - install-buildpacks:
          requires: 
            - clone
      - docker-build-run-image:
          requires:
            - docker-prep
      - docker-build-build-image:
          requires:
            - docker-prep
      - create-builder-image:
          requires:
            - install-buildpacks
            - docker-build-run-image
            - docker-build-build-image
      - test-go:
          requires: 
            - create-builder-image
